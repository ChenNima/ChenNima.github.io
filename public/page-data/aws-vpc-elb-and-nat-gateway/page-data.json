{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/aws-vpc-elb-and-nat-gateway","result":{"data":{"markdownRemark":{"html":"<p>在上一篇文章中<a href=\"/aws-vpc-internet-gateway\">从零搭建AWS网络(一): VPC与Internet Gateway</a>中，我们学习了如何从零开始搭建一套最简单的AWS网络并通过Internet Gateway来向公网提供服务。在文章的最后我留下了两个问题：</p>\n<ul>\n<li>没有详细配置Security Group等安全措施，安全性无法得到保障</li>\n<li>实例直接配置了公网ip地址，缺少安全性和可扩展性，占用宝贵的ip资源</li>\n</ul>\n<p>在今天的文章里，我们就来通过添加ELB，NAT Gateway等设施来解决这些问题。</p>\n<h1>1. 网络分层</h1>\n<p>目前为止，我们只有一层可访问公网的子网<code class=\"language-text\">Public Subnet</code>，整个VPC的结构可以简化地如下表示：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 391px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f3ec0a1b14988a730895104a86788a2d/14e0c/public-arch.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACJElEQVR42p2U2U/bQBDG/UfzUlGpfekrfaCCplQNBYleSqBRALUo8NCKUlWqkyqQOEDI4YQrpxMnXu/aX2e3SZqL9Fjp5/WMZ76d9Xqs4S+GWb5CieBc/DFW830fjLsTOC6DKzisdhuJZArGeRbFUhnCE+rZtByppckb4XkzV3UYQ8o4Q9dxlC0TxwenhVzOoTmuOzWgn5grmDjP5nB8koZxlkWjad0pKrU0NkNQDiE8MOai3miACwFvxm5GBQnf9wgxNMtD8ElEwLKavcrEFPwhQdq34A66VRP2bQ52Ja/oVAvkK6q5Tf6bfArd2i9bzgPIZs1rVZA8DxIUEF0LddNA4ugARvwQ+mEMxYwO3ihBEC4l1s0MvGYZvG4qkRGoAI+KksVpjN6L22kqZ/vmgsihdZ1V9mXRwImh0wnr0H98QToTR+Y0gRZV7IyJepyNC1IQVdKHEau7Ydx7sYSHa88UD9YCuL+6jOP0d/hUrXw1MwTzIyt2yA7uhLEQ2sBS5B0Wt14jEA3j0UYQevIrYF3+u+D6hy08332Plx+jWN/bQehTDI/Dr/5PUPI08gZzK4uYDy7TVgOKuZUniCe/keBdW6YLp1Pu3F5QVTmFTfesVsCR/hlv9yLY3N9GKBZFaD+KzYNtXBVT6rndy5HF+IL6fyBI3w+36+DtClEd4HcbALMmEHbtd1yrAuG0qKN6vaz+NvSFu+Tg1FbDSN90JuP6HfcTaBi2Tb8T7WkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"public-arch\"\n        title=\"\"\n        src=\"/static/f3ec0a1b14988a730895104a86788a2d/14e0c/public-arch.png\"\n        srcset=\"/static/f3ec0a1b14988a730895104a86788a2d/4edbd/public-arch.png 175w,\n/static/f3ec0a1b14988a730895104a86788a2d/13ae7/public-arch.png 350w,\n/static/f3ec0a1b14988a730895104a86788a2d/14e0c/public-arch.png 391w\"\n        sizes=\"(max-width: 391px) 100vw, 391px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>为了达到保护数据/主机安全的目的，我们需要将网络进行分层，把EC2主机从一个可以直接与公网通信的子网中拿出来，单独放入一个与外界隔绝的子网。如下图所示。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 381px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ee17d9c0d18cdbd662e1cab4c7112c21/2add2/private-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 94.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACf0lEQVR42p2U+0/TUBTH99ebGBP5wfiDJgY1BoOICkGDjocBYTxk6zZ0bKOjII/Rdu3Y+ry929dzSjfnxhS9yae3Pfecb88995HCX1q324XZsNBqO7hNS/FDdiQCIRAOEIQhIilRNwxkdnMoVVXoZiO2DfsykuyxYM+BMxmGm6Cxum6gpp0giqJ+1sOwKGulemI3Nd8PYBgmLgm1pkHXzThwXGl47I+CQkQ0TQsNqwmreUWZjhfkFguGNA0Z+nCtC7h2Pe496oOWAeE0ID07wULXt2Nb2DZ/h3y7wocgrVTAghRQyq5D2VpBnthd+wj7tIKgcQJX1+AZGtwE3zwewTOOEPGPIskZSoT8Yf+AaJ718UnstnimRoIWeLZ9QZ+M/yIyXpCWmuvg6mqc+v/AsYJrKWWyKCJA5Noxgv7ESK95eyiuG4W9KfOGjGjPOb8IHDjOFdrtMTij8GmLBSXtwfNzDen0HFaWF6ifx+LiW3wrbuNILUA9zI9QrSiolHMJCkrfv9IBOEPU6dDRo8dF/Rj5fAaFwhZyuU3klQyU4g4mP8zi0fw0Hg/wZGEGyv4OCRdQqZJ4tYCDgywM/fT66LFgvX6CSiWHWq0IVS3iWPuGTG4DE7NTeJ5+j6fMpwW8XlvGvVcv8GVvHVptn2KUAUHKUFKGQl4LlstZVOmvZXKqHRaxo2zi7vQz3CfRiTcv8eDdNB7OzeDO1CQy2Q0cDQnqlKHgDFnwkj7KB3tUm+v6HBLs9Hl7FUubS1jKLMek6X2VbCUaY59qAsde6kkNO7Qonu/hqmWP4LoteF6baCW0Y1vrBl/P98Faqd7V04nvNfTpELwDbqIz4DcIX7A/ASz0kcDeLQkIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"private-arch\"\n        title=\"\"\n        src=\"/static/ee17d9c0d18cdbd662e1cab4c7112c21/2add2/private-1.png\"\n        srcset=\"/static/ee17d9c0d18cdbd662e1cab4c7112c21/4edbd/private-1.png 175w,\n/static/ee17d9c0d18cdbd662e1cab4c7112c21/13ae7/private-1.png 350w,\n/static/ee17d9c0d18cdbd662e1cab4c7112c21/2add2/private-1.png 381w\"\n        sizes=\"(max-width: 381px) 100vw, 381px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>我们可以去VPC -> Subnets -> Create Subnet 来新建一个子网，Subnet name填写private-subnet-1。CIDR block可以选择<code class=\"language-text\">172.31.1.0/24</code>, 这个子网的ip分配空间为<code class=\"language-text\">172.31.1.0~172.31.1.255</code>, 与我们在之前文章中配置的Public Subnet的<code class=\"language-text\">172.31.0.0/24</code>完全没有重合。Availability Zone这里就选择与另一个子网相同吧，因为在AWS中，跨AZ通信一般都是要额外收费的，这里我们先不考虑可用性。因为我们不想将这个子网直接与Internet Gateway相连。所以需要给他额外配置一个Route Table。</p>\n<p>在VPC -> Route Tables -> Create route table 中创建一个新的路由表，选择我们之前创建的VPC。在在VPC -> Subnets里找到我们刚才创建的<code class=\"language-text\">private-subnet-1</code>并切换到Route Table选项卡，点击Edit route table association来将我们刚才创建的新路由表分配给这个子网。之后我们的EC2主机就可以在这个子网中部署了。</p>\n<p>不过由于这个子网并没有网络访问的能力，部署在其中的EC2主机就算分配了公网IP，也不能从外部访问，更不能访问外网。而所有面对公网的能力都被保留在了Public Subnet中。此时Public Subnet可以被称为<a href=\"https://zh.wikipedia.org/wiki/DMZ\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">DMZ</a>(Demilitarized Zone)，也叫边界网络。</p>\n<h1>2. Bastion Host 堡垒机/跳板机</h1>\n<p>有过开发或者运维经验的同学对<code class=\"language-text\">堡垒机/跳板机</code>一词肯定不陌生。在传统数据中心的网络结构中，也会经常出现这个名词。不管是云原生应用还是传统数据中心，计算资源和数据库部署的网络一般都是与公网隔离以保障安全性的。通过在Public Subnet中部署一个公网可访问的<code class=\"language-text\">Bastion Host</code>，再经由这台跳板机，我们就可以登录到部署在私有子网中的EC2主机了。对于这台跳板机，我们还可以专门设置<code class=\"language-text\">Security Group</code>规则，仅允许你个人电脑的IP以及端口22(SSH)的inbound流量，来保证不被其他人攻击。此时的网络结构变为了下图所示。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 381px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/30a8d82bb1b90fc180f32c62b5c680ed/2add2/bastion.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 94.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAAC+ElEQVR42pWU+VPaQBTH89fbcVpnnDrOdGqdqhWPajvq+EMtHlWrqCiBgAcgESwiJJw5NuSAb98GtIhH2535ZJPd97778vbtCvhLa7fbKFeq0HQD/9IE/vBaHpqOA7uHpm3D9TwUVRUHYRHn6QyUcsUf67fleDTuC7qeSwa2H8kdrS682baDYkmBnL2G67r3UffDRfliAl+t3XXub1aziV/5GxJUkZFzUJSy7/hcavicwMiJWRZFYsNudtA0HQ5N6pS3wm0J1VoD1XoDxRcE/b/hgiaJnUoikmci4rEwpOgRIsf7yKTiYI0SWlYNHuNU0aZ3x6jA1ssP0VS0HQsOpUSwXQ+OWYWVOwNLiWhmJNTih7gJb6OpZmESrNtzrHLuEUy9gssXIi3BbrVglwswpsbBviyAzc1Amw2gPvIW7HAbln7bcaxcPwsrZ0mwSoLuH0FteAjG2BjYpymwyQnorwZg7gZhGUVY6v8IeiRYK0F7NwJ9lJidhjE9CW1wAEZ4B6yeB1Nk/7eew1QycHguednYLhWlS0WsU9GSsKXk0cjLcBsqbUQdrlnz+xchmzZpdCJ0eUG6VDomLJtRkVswLINOBUWt1WCaOpVP4yHGY/hp8wU9KshCIYtgcBmbG6vUr2BtbQkJ2umEdIC4FMKVHEfmMnZPOhVFKil2ieL87BiqegOX9kPgj9tiDrFYCBIJiOI+YtEQYqdhjC3P401gHB9WF/B+Zd5nnN6jiSMSlpBKk3hawsVFBCqlyj96XLBYvEaKalDmkWTiyGVPERL3MPx1FoHNb5j4vuqzuLOB15+n8fNkF1k5QT7RHkGKkDZYcLyOYDIZQZpWTZKRfBnHEUU5ODeJocWALzyyNI/R5QUMzHxEKLJHaXgoqFCEDo+QC5boI3lxQrnp5OeS4EY/Drewvr+O9dCGT5Det2jsnOa4TboL9y0p3Rzya4pZDA3a0X5MUwNjOqF10f0x7QlbfsFwLeHu6mn59xruaRG8Ap6i1WPXC79gfwNBzITPr2x+xgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"bastion\"\n        title=\"\"\n        src=\"/static/30a8d82bb1b90fc180f32c62b5c680ed/2add2/bastion.png\"\n        srcset=\"/static/30a8d82bb1b90fc180f32c62b5c680ed/4edbd/bastion.png 175w,\n/static/30a8d82bb1b90fc180f32c62b5c680ed/13ae7/bastion.png 350w,\n/static/30a8d82bb1b90fc180f32c62b5c680ed/2add2/bastion.png 381w\"\n        sizes=\"(max-width: 381px) 100vw, 381px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>AWS有一篇<a href=\"https://aws.amazon.com/blogs/security/how-to-record-ssh-sessions-established-through-a-bastion-host/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">文章</a>详细地描述了如何创建跳板机，以及一些安全操作，比如对SSH进行audit log，以及对跳板机的SSH秘钥进行管理和更新等。但一个基础的跳板机的创建其实极为简单，仅需要将跳板机部署到Public Subnet，然后将Private Subnet中主机的SSH秘钥上传至跳板机，并且把跳板机以及EC2主机之间的Security Group配置成允许22端口，就能通过跳板机对EC2主机进行SSH登录了。不过登上EC2后你会发现仍然无法访问外网，并且部署在EC2上的服务并不能从公网访问。</p>\n<h1>3. NAT Gateway</h1>\n<p>由于现在的EC2主机部署在了<code class=\"language-text\">Private Subnet</code>中，给这台机器配置一个公网IP是没有意义的。此时EC2主机的ENI仅分配有一个私网IP。而必须持有公网IP才能访问互联网，那怎么办呢？在上篇文章中介绍过<code class=\"language-text\">Internet Gateway</code>可以通过将子网中的ENI持有的私网IP与公网IP进行双向NAT转换，达成了EC2主机与公网的双向通信。那对于<code class=\"language-text\">Private Subnet</code>中的主机，访问外网就需要一个<a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">NAT Gateway</a>将EC2的私网IP单方向NAT转换为一个公网IP。同时，为了获取一个公网的IP，这个<code class=\"language-text\">NAT Gateway</code>需要与<code class=\"language-text\">Internet Gateway</code>相连，也就是必须部署在<code class=\"language-text\">Public Subnet</code>中。部署了<code class=\"language-text\">NAT Gateway</code>后的网络结构如图：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 381px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aea63aace58f5da790f4142801b9b684/2add2/nat-gateway.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 94.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADUElEQVR42o2UiU8TQRTG9183Jt4kJlqQIOEQilwKBOLBIfGgSqU3R1taytVud3uw10z3aD/fDBWxSnSSb2f37ZvfvH3v7Sj4x+h0OqjVGzAtG/8zFHEJ2gFangf3mlquCz8IoOo6vkbj2M8XoNXq0tbrKxSQXQL9wCcHV0byU+2uxHBdD6qmo1g6ge/7V1H3SkDFZorYrdNd3Ds4b+G8XMFhoYjt6A7qjSZt4N6YGgFVWKsFxrl0dFuXMk0LHr20LAsVVYNKOjk9g6bXZcQ3DQl0CLabiiO7F0c6GUUqsY3Y9y0Ucmkwo4qOb4HbdRjNCiXbhscoSqv2u0wdHY/Do5Qorh/Acxrgx3tguThahRSa6W84j35ESy+Bkd3Y30EtGQErpOEc7YKTndeOr8T0I/i0qWApbrsNt1aGPT4MNj8L9jIMMzyBi9BTOBtvYPY9gD0QAltagD04APP2LbBsAtwoXwLrJ2C1EgEbBPR/Ac3HfbCHhsBejIONjsB6cA/28jxB+gnYL+12fwjW/btgu1Fws3IDMCBgswrz2RNYIdLUBOyJMZgPCbj5Fs78DJy5aVxMvZCzMxOGc7AD1jwF04rycx2tAE/kUrSN61NT+tTEFjUtgbl2BuOsCN/QEbALeA0V7QsNpXQMvHqGwKhJ+29ymlQ8txuhLxrSp9ZxwF1GTc5hc5v+CorabMKhe/Gs6ipMx4QlZBt/SPxtEhhQQ5bLJayuLmJjfZnmJbx7t4AMVTqT+op0KoLSUQbJ+BYOcwkUD1PI05zLxrtKYH/vO3T9HD7VQxGXinqMJLVFigBxWphMRJCkxA8tTuPR5DCer8xi4HUYg0vTGF6ZQyKzjQKBc/kk8vkUDg5i0ClV8tcTQFU9QY56sFhMo0C9dlzaRST+BY9fTWFy4y1G3y9jbHUFcx/X8XBmAp93PqFUzNCaxDUgRUgFVrzgEpjNxpCnXbPys9LYpijvvxxD39ykBD9ZmEZocRZ3wiOIxL7gqAeoUYSeiFAAq/SQpVbI55IyPyJXwmnz2wesba1hLbIutUr3H8i2T++ET74rsbaqdXMojinGGQyqaK8cqihjFsnsypI28y++4oARLOXn0dOW5xqu1CaJDvib2tf8rkscsD8Agid5FdOJbnsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"nat-gateway\"\n        title=\"\"\n        src=\"/static/aea63aace58f5da790f4142801b9b684/2add2/nat-gateway.png\"\n        srcset=\"/static/aea63aace58f5da790f4142801b9b684/4edbd/nat-gateway.png 175w,\n/static/aea63aace58f5da790f4142801b9b684/13ae7/nat-gateway.png 350w,\n/static/aea63aace58f5da790f4142801b9b684/2add2/nat-gateway.png 381w\"\n        sizes=\"(max-width: 381px) 100vw, 381px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>部署<code class=\"language-text\">NAT Gateway</code>分为两步:</p>\n<ul>\n<li>在VPC -> NAT gateways -> Create NAT gateway中新建一个<code class=\"language-text\">NAT Gateway</code>，只要选择部署到Public Subnet，并分配一个新的<code class=\"language-text\">Elastic IP</code>即可</li>\n<li>在VPC -> Route tables里找到分配给Private Subnet的Route table, 点击Edit Routes编辑路由表。点击<code class=\"language-text\">Add route</code>，第一列填入<code class=\"language-text\">0.0.0.0/0</code>代表匹配所有其他ip。第二列选择<code class=\"language-text\">NAT Gateway</code>并选中刚才我们创建好的。</li>\n</ul>\n<p>部署完毕<code class=\"language-text\">NAT Gateway</code>后我们的EC2主机就可以访问外网了。我们可以通过跳板机登录上机器后执行<code class=\"language-text\">curl ip.sb</code>，返回的IP地址即我们访问公网使用的IP。这个IP应该与我们分配给<code class=\"language-text\">NAT Gateway</code>的<code class=\"language-text\">Elastic IP</code>保持一致。你可以尝试多部署几台EC2主机在Private Subnet中如下图所示</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 402px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ebe5cde52525acfe7416542ddfc737d4/0ec92/nat-gateway-explained.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.28571428571428%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABvklEQVR42qWS7U/aUBTG+f//hgV12UQYZJjgS7LI+6IIwgIYBjJoaSkyUNvSAqWU3y51fvCDoOEmT+7Lec6T55xzA2xZrusyGo1wHIf3rMA2wmAw4K7dRlVVnnR9N0F3uaRWryPJMnedDvVGg9VqtZtDTdPoSBJD4fRhOHx+3CC6VXA2m2FPJrg3Jeyf+Y1i7xK0bJuFGMj8dwOzcLVLD5+dWNbE79vUsngYj/9X/MGSX+hqu0blMknntsSvQprqdYaR0nrF+ZCg0qyQOolSvUqSOf9O/kecfru60eWbJXviy8wtnZn5SL1SpFEt405NFgJLEXuzZM/zmC8cFu6CuTNHN3QM08AWw7DFhF0Rn6z79/Qo/qWHNZ36Md0wfK7zkit2b+UR6A0ULgop0sUs3xIxkqJXa3RViWKtSK6cJ5E85Sx9TqaU4+a2zB+l43MuLlNET2JkS3n/3v+rEZA0ma/HIYLhfR+H8SMipzGa3Rbp6yyfQkH2IgcCnwknIuREclNq8SV+yF74gODRPqHjMJGzKGtzgcnUQlJlH8q9itzv+WfTMrkfD+kqXZ/Y0xTf9VC8GSK2Psv91znWzOYfD/8mAgsmAb0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"nat-gateway-explained\"\n        title=\"\"\n        src=\"/static/ebe5cde52525acfe7416542ddfc737d4/0ec92/nat-gateway-explained.png\"\n        srcset=\"/static/ebe5cde52525acfe7416542ddfc737d4/4edbd/nat-gateway-explained.png 175w,\n/static/ebe5cde52525acfe7416542ddfc737d4/13ae7/nat-gateway-explained.png 350w,\n/static/ebe5cde52525acfe7416542ddfc737d4/0ec92/nat-gateway-explained.png 402w\"\n        sizes=\"(max-width: 402px) 100vw, 402px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>你会发现所有主机的公网IP都与<code class=\"language-text\">NAT Gateway</code>一致，也就是说<code class=\"language-text\">NAT Gateway</code>将Private Subnet中的私网IP多对一地映射成了自己的<code class=\"language-text\">Elastic IP</code>，节省了IP资源。这里<code class=\"language-text\">NAT Gateway</code>会对outbound流量的网络回包进行处理，送达至对应的私网ip，保证从EC2发出的网络请求响应能顺利送回。但如果直接从公网访问<code class=\"language-text\">NAT Gateway</code>的IP地址，并不能触达私网中的EC2主机。也就是说<code class=\"language-text\">NAT Gateway</code>是一个从内网到公网的“单行道”。</p>\n<h1>4. Elastic Load Balancer</h1>\n<p>那如何才能安全地对外暴露EC2提供的服务呢？那就需要使用<a href=\"https://aws.amazon.com/elasticloadbalancing/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Elastic Load Balancer</a>。顾名思义这是AWS提供的负载均衡器，总共分为三种：<code class=\"language-text\">Application Load Balancer</code>(ALB), <code class=\"language-text\">Network Load Balancer</code>(NLB), 和<code class=\"language-text\">Classic Load Balancer</code>(CLB)。其中ALB是针对7层(HTTP, HTTPS等等)的，NLB是针对4层(TCP, TLS, UDP等等)的，而CLB可以同时提供4层和7层服务，但已经是不被AWS推荐的过期产品，对比较新的功能的支持是有限的。ELB和<code class=\"language-text\">Nginx</code>, <code class=\"language-text\">HAProxy</code>等负载均衡器所提供的功能非常接近，但它是完全由AWS部署运维的，你只需要新建一个ELB并且配置规则即可，不需要考虑它是如何被部署的。\n首先，我们去EC2 -> Load Balancers -> Create Load Balancer创建ELB</p>\n<ul>\n<li>首先我们选择ALB</li>\n<li>Configure Load Balancer:\n<ul>\n<li>Listeners: 选择默认的HTTP和80端口</li>\n<li>Availability Zones: 选择我们的VPC以及Public Subnet。如果所选的Subnet没有与<code class=\"language-text\">Internet Gateway</code>相连，这里会给出警告。在当前的版本AWS为了可用性会强制要求ALB部署在两个或者以上的可用区中，可以自行在一个新的可用区新建一个Public Subnet。</li>\n</ul>\n</li>\n<li>Configure Security Settings: 由于我们选择的是HTTP而不是HTTPS，所以这一步可以略过。如果要暴露HTTPS服务，可以在这一步选择HTTP证书，ALB可以帮你做HTTPS证书卸载，并且支持SNI。</li>\n<li>Configure Security Groups: 选择Create a new security group。默认会为你准备好允许80端口TCP的规则。</li>\n<li>Configure Routing: 使用默认配置即可，新建一个target group。</li>\n<li>Register Targets: 手动选择在Private Subnet中创建的EC2主机</li>\n</ul>\n<p>此时我们有了一个指向EC2主机的ALB，对EC2主机，编辑Security Group允许从ALB的Security Group来的所有流量，并且登录到主机上开启一个监听<code class=\"language-text\">0.0.0.0:80</code>的HTTP服务，等待ALB的Health Check健康后就能通过访问ALB提供的DNS域名访问到EC2上部署的HTTP服务了。通过在<code class=\"language-text\">Target Group</code>中部署多台EC2，也可以达到负载均衡的目的，配合<a href=\"https://docs.aws.amazon.com/autoscaling/ec2/userguide/AutoScalingGroup.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Auto Scaling groups</a>更是可以做到弹性伸缩。部署好ELB后的网络结构如图:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 381px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/83310eaf939ae44c6c15589bb7c044e7/2add2/elb.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 94.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADd0lEQVR42o2UiU/bSBTG89dXDQsVKwq0YquWI1wpLbD0WiCtqi7hjMkF5CRQSBw7l8f3kXz7ZhIQm1ZqLX22Z+bNbz7Pe54QfnH1ej00mi0w3cDvXCF+C7oBHM+D+0CO68IPAsiqiv0jCeeFEpRmU/QNx3IF1C+AfuBTgCuc3Kk7EL9c14OsqChXruHRxDvXw+JQvliIr9YbTB6+bNvBbbWGYqmMw+MEqrU6fbp+Dx3eGg4NWY4Dy7bJiQvX6YsxXbjRaXJNViDLdVx/v4HaaIkx7rpP+b8BATQJlk1JyJ1JSCePkDo9ROJ4D6V8GpZWR8/XYRtNaO0abbYB3+nAaNWgtarw7DapA9dsoufZ8HwfIdcP4Jkt2FdnsPISnFIK7fQBbo++wlErsKhfOz9BIxmHVUrDvMzCUS7B8qe42o/ByEkUk4VPi7oC2O3CbVRhzL2AtRaFtbwItriAzuRTmLEPYGMjMKYnYW2uw3g2BRZ+BHP3PfTRETRHHkOjJ3s6Dr+jgLPugWx8DMbMDKz5OVivXkKnYGNrDcbzKQJOiX6DFtF53GaUxsOwFuaF2Ohj+C15AAwI2KbsPZuAPklaWoCxMAv2BwG/fIS5tgrz9Qo6S/Mwo8sw30ZhxN6T8zA6T0bIYRhs+k94nfoA6FNR+lTEOhUtgW3lBtpNGb6mIrA68GjlLn1OJZ2AXb/p91MiHIrVqR2wBuWKkkKM/h76vCB9Kh0TtmtRkdswbANKg1yzNkx6521ZlaEZmmhrWhuKSkCTCTGDib9NAAMqyGq1gu3tDcR2t+i5iU+f1pGhTGdS+0in4qhcZpCU/kWpmMRZ5hBS4hvylN07nZ8dQ1Vv4fNP5reafIUklUWKAJK0h+RpHMnsEWY2VjAaeYG/3kUx/SaCmb9XMbE6h4OTb7gsZ5Cn0ikUUri4SEClrRK/HgfK8jUNSiiX0yhRrV1VsoiTo/E3S4jEPuLVP1uY3X6H6NddjK1FsEcOKz8AySElOOQFfWAul0ChmEKOgsrFNA7JZXh5FmOvIwI8sb6CyY0oHi2+RDzxo0OFHHrcIQfWqZG7OEEhnySdokjiQV8OPmNnbwc78V2hbXr/TH3nNMZjCgPxuXVlsIf8mLJsCxpldFgmZdCydBIbSBd97Cex/IDhrNDd0dMV5xru1SXxCviZug/iHoofsP8BP5JuQ5SeT4oAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"elb\"\n        title=\"\"\n        src=\"/static/83310eaf939ae44c6c15589bb7c044e7/2add2/elb.png\"\n        srcset=\"/static/83310eaf939ae44c6c15589bb7c044e7/4edbd/elb.png 175w,\n/static/83310eaf939ae44c6c15589bb7c044e7/13ae7/elb.png 350w,\n/static/83310eaf939ae44c6c15589bb7c044e7/2add2/elb.png 381w\"\n        sizes=\"(max-width: 381px) 100vw, 381px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1>5. 总结</h1>\n<p>至此，我们已经搭建了一个出具规模的二层网络，将内部可信流量与外部不可信流量区分开，并且通过<code class=\"language-text\">NAT Gateway</code>与<code class=\"language-text\">ELB</code>为计算资源的弹性伸缩做好了铺垫。从图中我们可以看到，不管是<code class=\"language-text\">跳板机</code>，<code class=\"language-text\">ELB</code>还是<code class=\"language-text\">NAT Gateway</code>，所有的流量都是单向的，并且有自己的目的。我们可以通过配置不通的安全策略来控制每一条路径的安全性，使得整个网络结构安全可控。</p>\n<p>在接下来的文章中我们会介绍：</p>\n<ul>\n<li>如何安全快速地在VPC中访问AWS提供的诸如S3之类的服务？</li>\n<li>如何在AWS中访问数据库？</li>\n</ul>","excerpt":"在上一篇文章中从零搭建AWS网络(一): VPC与Internet Gateway中，我们学习了如何从零开始搭建一套最简单的AWS网络并通过Internet Gateway来向公网提供服务。在文章的最后我留下了两个问题： 没有详细配置Security Group等安全措施，安全性无法得到保障 实例直接配置了公网ip地址，缺少安全性和可扩展性，占用宝贵的ip资源 在今天的文章里，我们就来通过添加ELB，NAT Gateway等设施来解决这些问题。…","frontmatter":{"date":"April 19, 2021","path":"/aws-vpc-elb-and-nat-gateway","title":"从零搭建AWS网络(二): ELB与NAT Gateway"}}},"pageContext":{}},"staticQueryHashes":["2560569871","3584596544","3649515864","63159454"],"slicesMap":{}}