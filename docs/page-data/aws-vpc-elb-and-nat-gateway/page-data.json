{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/aws-vpc-elb-and-nat-gateway","result":{"data":{"markdownRemark":{"html":"<p>在上一篇文章中<a href=\"/aws-vpc-internet-gateway\">从零搭建AWS网络(一): VPC与Internet Gateway</a>中，我们学习了如何从零开始搭建一套最简单的AWS网络并通过Internet Gateway来向公网提供服务。在文章的最后我留下了两个问题：</p>\n<ul>\n<li>没有详细配置Security Group等安全措施，安全性无法得到保障</li>\n<li>实例直接配置了公网ip地址，缺少安全性和可扩展性，占用宝贵的ip资源</li>\n</ul>\n<p>在今天的文章里，我们就来通过添加ELB，NAT Gateway等设施来解决这些问题。</p>\n<h1>1. 网络分层</h1>\n<p>目前为止，我们只有一层可访问公网的子网<code class=\"language-text\">Public Subnet</code>，整个VPC的结构可以简化地如下表示：</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 391px; '>\n      <a class='gatsby-resp-image-link' href='/static/f3ec0a1b14988a730895104a86788a2d/14e0c/public-arch.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 82.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACXUlEQVQ4y41UXW8SQRTlXxtfrJqoD0bfaiwNJJaWpB/GtLUJ9qFRiMYoSdEQasHKQvkuC+xS9mNml+O9M9AAUvUmJ3fmzpmz986d2QjIgjCEL8UfEFLCEz6+F34gf1ZEo9WGDAL4YoFLc46zRXjCm1h0HgFC8oxO10Txooyu2VObePMslzmswwlEWIwDt1l/YMGyhzg7L6HV7sB1vVu5ru/pDAMlOMZ4PA82zqrWaKJsVFCrNzGwbBVfxlWCHglOM+T4eMbP2shx8C/TGVLdAZ+JS1/2LIxdC/BthO4A/tAkdOHZV+g2DDVmiGsTgtbY81w61nyG0h/Bbv5EMfcJRiGL89xH1Es5OF0DzpVGp5yHO5mPODaz5lyVEUoPLmmppgh3SKQyquenqJW+oUyibaMA0a/BNau0uYJOpaDGHsHvXVKsqubT9VA4WlC1mwRdswJp1SEGGqHdQCabwcv9bcSPXmP9YIf8HqKHOygWcwiIMyIhLWgsEaRFZwIuSVAWidQb3I2/wP2NKO69WsODxDruxFaR/poGnRGuifdXwWn6DC5r9+QI8dQBkicpbL8/xtvPGawe7JHgByU4+j9BLSr6l0ge7+PhZgzPdjfxdCeB53tbWKEs09nFDBfP0LF116Yl01hSQw7T77CysYYnyTgebcXwOBmjsqM4zX9BSOetu13RXZ4KqmtDnfYHDbhUpkfQvkbCVXSbFzBn0Gv9oqw0T3F5THvHoaR76PPF5p8DidIFF8JTkDee3nkg5iHFzfoUQSC1Bj2QCN9wfnr8pxAUmAPF/CVYxgsmz/c3xuO0MzhejEQAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='public-arch' title='public-arch' src='/static/f3ec0a1b14988a730895104a86788a2d/14e0c/public-arch.png' srcset='/static/f3ec0a1b14988a730895104a86788a2d/4edbd/public-arch.png 175w,\n/static/f3ec0a1b14988a730895104a86788a2d/13ae7/public-arch.png 350w,\n/static/f3ec0a1b14988a730895104a86788a2d/14e0c/public-arch.png 391w' sizes='(max-width: 391px) 100vw, 391px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>\n  </a>\n    </span></p>\n<p>为了达到保护数据/主机安全的目的，我们需要将网络进行分层，把EC2主机从一个可以直接与公网通信的子网中拿出来，单独放入一个与外界隔绝的子网。如下图所示。</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 381px; '>\n      <a class='gatsby-resp-image-link' href='/static/ee17d9c0d18cdbd662e1cab4c7112c21/2add2/private-1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 94.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAACmUlEQVQ4y52U6U8TQRiH94/3kxqNiVE/qSSCqKCCB4k0BYICLZYeYG3pQYvQY6+2W/Y+fr7vdAstQiBu8mS2O7955t3pzkhRFOGmS9V09AfGjTl2SXzjBwEczyW8uCVcF17gQyHZVnoPxXIFra4MPwxE33kuHsNZvqSxjO2ThGEoAtwqqoZqvSEmHj+7nHdJ7Pk+JJaFUXheMuIAX47joisrkBVVCNudLmzbmcoKEOfJJbE5vGYduSJF60HVe+jRGnZklSbxrl3DkZDKDDwbZ1or5hSm3oIz6MIbKggtXRCYGiJbp2cqXEOegrOha4r1lBwW2gNUcj+Q3UqgkFpDan0FSrMIRz+GKR/BVC6wlAYsdRpTrsNjMQtdP4B71oNLg73+KdzeiWht7Q8s7Zjam2EpV34hNHvxzNzZHHFL2dXCM53KrpH06L/gseKV+bNxfQ+B7yKw+vDHmH3x+9bQG0a+M66QP0gPpmmMsJghhsM+BkbvSoxL8DOfHOySgjCij/cEicQy8Qmrq8tYWXmPfG4L9WoBlcMcqpVpDg+zKJf3YrIoFnfR6TRp+wW09WgbyfIpCoUdIoVcbhv5/DYKB7t48XURTz6+xtOl+XOeEWnqr9f2SZxDpVJAqbSHdrs52nosVJSWmLVGoSpV1Tj6hQxN8HBxDjOrX/Dy22fBwmYS9xdmkdhOolk/QFkI80IoKhwLucJSKSM6OVQjaXY/hbtvZnDv3Ss8WJzFow/zeLz0FnfmnmM9vYHGlDBDFTYmKlTbYj24syJCORH+/nMTSdo5azHJnSQ20uso/s7QWubjV86Lse3OMXgbS3xqWI6NAf+rExiEaQ5hWf9iDAfTeYOytiUOGXHA8lkTjs/BiZYJJu4nia5o+foLuL+QfQ9SaKwAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='private-arch' title='private-arch' src='/static/ee17d9c0d18cdbd662e1cab4c7112c21/2add2/private-1.png' srcset='/static/ee17d9c0d18cdbd662e1cab4c7112c21/4edbd/private-1.png 175w,\n/static/ee17d9c0d18cdbd662e1cab4c7112c21/13ae7/private-1.png 350w,\n/static/ee17d9c0d18cdbd662e1cab4c7112c21/2add2/private-1.png 381w' sizes='(max-width: 381px) 100vw, 381px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>\n  </a>\n    </span></p>\n<p>我们可以去VPC -> Subnets -> Create Subnet 来新建一个子网，Subnet name填写private-subnet-1。CIDR block可以选择<code class=\"language-text\">172.31.1.0/24</code>, 这个子网的ip分配空间为<code class=\"language-text\">172.31.1.0~172.31.1.255</code>, 与我们在之前文章中配置的Public Subnet的<code class=\"language-text\">172.31.0.0/24</code>完全没有重合。Availability Zone这里就选择与另一个子网相同吧，因为在AWS中，跨AZ通信一般都是要额外收费的，这里我们先不考虑可用性。因为我们不想将这个子网直接与Internet Gateway相连。所以需要给他额外配置一个Route Table。</p>\n<p>在VPC -> Route Tables -> Create route table 中创建一个新的路由表，选择我们之前创建的VPC。在在VPC -> Subnets里找到我们刚才创建的<code class=\"language-text\">private-subnet-1</code>并切换到Route Table选项卡，点击Edit route table association来将我们刚才创建的新路由表分配给这个子网。之后我们的EC2主机就可以在这个子网中部署了。</p>\n<p>不过由于这个子网并没有网络访问的能力，部署在其中的EC2主机就算分配了公网IP，也不能从外部访问，更不能访问外网。而所有面对公网的能力都被保留在了Public Subnet中。此时Public Subnet可以被称为<a href=\"https://zh.wikipedia.org/wiki/DMZ\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">DMZ</a>(Demilitarized Zone)，也叫边界网络。</p>\n<h1>2. Bastion Host 堡垒机/跳板机</h1>\n<p>有过开发或者运维经验的同学对<code class=\"language-text\">堡垒机/跳板机</code>一词肯定不陌生。在传统数据中心的网络结构中，也会经常出现这个名词。不管是云原生应用还是传统数据中心，计算资源和数据库部署的网络一般都是与公网隔离以保障安全性的。通过在Public Subnet中部署一个公网可访问的<code class=\"language-text\">Bastion Host</code>，再经由这台跳板机，我们就可以登录到部署在私有子网中的EC2主机了。对于这台跳板机，我们还可以专门设置<code class=\"language-text\">Security Group</code>规则，仅允许你个人电脑的IP以及端口22(SSH)的inbound流量，来保证不被其他人攻击。此时的网络结构变为了下图所示。</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 381px; '>\n      <a class='gatsby-resp-image-link' href='/static/30a8d82bb1b90fc180f32c62b5c680ed/2add2/bastion.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 94.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADA0lEQVQ4y5WUjU/aQBiH+eOXfZplui1uJtv8Hn5tU5e4OIcapyhTKCAKAio6pXwJbbm2R1t+e++oBjaN2SVP7tp7+9x717sLtNtt3FeqtSs0NP3eOOEKiIbjurBbnGj5NcE5Wq6DCsm2IlGkMllclspwPFf23cT534hYUQJSRgHC7rU9gmrPk4gi6kq1htxxQQ58/U7Ed8NJ3HIcBMQIdxXOWyicnUOlzPIkvFRLsCz7Znq4Bp1lE5kGLG6jyRi4zSnYgm3b0DSNZByMmVJSu2qg3tChlqvUf3cCvpAjlYwjvb+HhLKDeGwb0d1NZA4VsHoRnnklcVkNbesKLaMKrpd7sLUSPM7kegY4rYtr67AKKVjpKHg2Dm0/gvPwD1hqHqxySpzcYNKzWe2FlY/REuJroa1VYYx/AJuZBgtOwvg4icbLAbD1ZViGCqtSgFU7uxMhFZn7Qo/SrkJ/3Y/m4CDY2CjMkWEYjx6iubwIq1n6X6EL3qxDHx4i6QCMqQkYwXHofU9gbK7AbPyWUzLldG+HlfOdKYttI/aP63C4JHW0CnitCO2CRqS2Z2lwzAbc+2B1tB3bz9ARG7IFZhpglgHTZmiaOkoVlbZKjbaUDk2v96D/hXjnkEO4Aq7XRql8gZWVBWIR35fnsbT0CXFlC/vJbSixTeRzCWSPFOSyHY6OYshkoj4xHBz8gqoW6Pi5dPToGJVJmEhsEztQlDDJwkimfuHd4gwejw7h7cIUBr8EMTgfxBsiEg/jOJ8ksYJsNoE0bbdisdA5ekJYqVzKUfMUlKNsTk9S2KUBXsxNYjz0DcPLXzFCzG6E0Dc7gZVwCIXjfWSkMC6FMsNrocgwnd6TnSJITDGW3MHTqRE8mx7D87kJ9H8O4tX8NB5MvsdaZB2nPcI9yvC0K8NqUa6H6MzKIEUG/9zdQGhnFas+oe0Q1iNrODjco7WM+1OOy2+L6hn9FBKKW8O0LWhGowedYIz+uvkvuqH1xusUa5ny6pMXrLh8PP9e664Fble7m/YttSh/AOYfg5WsxU+gAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='bastion' title='bastion' src='/static/30a8d82bb1b90fc180f32c62b5c680ed/2add2/bastion.png' srcset='/static/30a8d82bb1b90fc180f32c62b5c680ed/4edbd/bastion.png 175w,\n/static/30a8d82bb1b90fc180f32c62b5c680ed/13ae7/bastion.png 350w,\n/static/30a8d82bb1b90fc180f32c62b5c680ed/2add2/bastion.png 381w' sizes='(max-width: 381px) 100vw, 381px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>\n  </a>\n    </span></p>\n<p>AWS有一篇<a href=\"https://aws.amazon.com/blogs/security/how-to-record-ssh-sessions-established-through-a-bastion-host/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">文章</a>详细地描述了如何创建跳板机，以及一些安全操作，比如对SSH进行audit log，以及对跳板机的SSH秘钥进行管理和更新等。但一个基础的跳板机的创建其实极为简单，仅需要将跳板机部署到Public Subnet，然后将Private Subnet中主机的SSH秘钥上传至跳板机，并且把跳板机以及EC2主机之间的Security Group配置成允许22端口，就能通过跳板机对EC2主机进行SSH登录了。不过登上EC2后你会发现仍然无法访问外网，并且部署在EC2上的服务并不能从公网访问。</p>\n<h1>3. NAT Gateway</h1>\n<p>由于现在的EC2主机部署在了<code class=\"language-text\">Private Subnet</code>中，给这台机器配置一个公网IP是没有意义的。此时EC2主机的ENI仅分配有一个私网IP。而必须持有公网IP才能访问互联网，那怎么办呢？在上篇文章中介绍过<code class=\"language-text\">Internet Gateway</code>可以通过将子网中的ENI持有的私网IP与公网IP进行双向NAT转换，达成了EC2主机与公网的双向通信。那对于<code class=\"language-text\">Private Subnet</code>中的主机，访问外网就需要一个<a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">NAT Gateway</a>将EC2的私网IP单方向NAT转换为一个公网IP。同时，为了获取一个公网的IP，这个<code class=\"language-text\">NAT Gateway</code>需要与<code class=\"language-text\">Internet Gateway</code>相连，也就是必须部署在<code class=\"language-text\">Public Subnet</code>中。部署了<code class=\"language-text\">NAT Gateway</code>后的网络结构如图：</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 381px; '>\n      <a class='gatsby-resp-image-link' href='/static/aea63aace58f5da790f4142801b9b684/2add2/nat-gateway.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 94.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADZ0lEQVQ4y4WUaVMbRxCG9ctT+ZBKbMdFBQwmIXECNqcMDmAnThki22VsHQjdUiSELmSQtCsh7ezOHtpdvekZhCNVTHmq3urZmd6ne3qOwGg0wpdat3eFgca+6CdYAdFxPQ/20CENx5bkOBh6LlSCfYglUCiVcdlR4PqenPvkN/5H+IoWkDByEHR/5JPI+r6UaMKq3R7OqnV45HszJvwn5RB46LoIiAi3NYcCNT9eolqrIxw5hqL2YFrWp+XhRrgum8g0YDk2DM7h2A4scrZtG5qmSZjBTbTaCjodFefNCwm0LPvWBMZAB/lsGsXcCTKpKNLJCBLx9yj9kwLvt4Ahg2NeQbu6BDwdQ+sKDlOmZGsd+A6X9Qw4VBfPZrAaeVjFBJxyGlouhmb4b1jtCngtBy0fh5p8D5PmOMnsVGB26zDVurRcqVJc5T+grXWhr/4G/jQIvrkOtrGGwcID8IMXYHMz0OdmYe7twvhlCdrXX4Gno7BYC5bagNU7l9Ch3r0B+pR2F2xhFsbiIviTx+Ary9Dv3oG+G4Tx6GcYC/OwaNxYfAj23bfg8SNYevs2oAfH6IMtLxF0DvrWGvSNVbCZe9BDf8LY3wHfCaK/SePPaAXbWzCyUZiDplyqqdbIVq6XLI6NOD+e68AjqKupcHotaBcUkfq+xTAcKBhR/7xA9Ws34bMePHMwLd7HyLXHGbriQA7BTR3c0mHaHIbJ0FHb6A961NfBOENbaaHPaCWGBk3YCYlvlxiCFfD8ETrKBQ4P90nPcfBqDy9fPkM69QG5bATJxBFqlSxSSXGUTlChXT49TaJUSoyVRKFwjHa7QdfPo6tH10ghYCYTIUWRSoUJFkY2f4xHz5/izuMl/LQfxPzOGhZ3N/Dj3hZi6TCqFOT0NIVyOYMiHbdWq3F99QRQVS9l1Ao5nZ1lUK/lEacAP+ysYzX0F5ZfvcDKwR/YfhfC/e01HIZDaFRzKElgWgJlhjdAkWGxeCInhVOFoEnayXtbK/g++AQzlN3s75uY3wvim/Vf8Sb2FvUp4AllWJ/IsNuS9RCTZemUks5H8XcIRV/j9VihSAhvY29QoFqeyVpeA8W/rfY5bQoBxath2hY0fTAlRuKcdt38v5iuTfsz8rVM+fTJB1Y8Pv74XZu0Qt5Ef1Kjz1jR/gUBKnfRyauH5wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='nat-gateway' title='nat-gateway' src='/static/aea63aace58f5da790f4142801b9b684/2add2/nat-gateway.png' srcset='/static/aea63aace58f5da790f4142801b9b684/4edbd/nat-gateway.png 175w,\n/static/aea63aace58f5da790f4142801b9b684/13ae7/nat-gateway.png 350w,\n/static/aea63aace58f5da790f4142801b9b684/2add2/nat-gateway.png 381w' sizes='(max-width: 381px) 100vw, 381px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>\n  </a>\n    </span></p>\n<p>部署<code class=\"language-text\">NAT Gateway</code>分为两步:</p>\n<ul>\n<li>在VPC -> NAT gateways -> Create NAT gateway中新建一个<code class=\"language-text\">NAT Gateway</code>，只要选择部署到Public Subnet，并分配一个新的<code class=\"language-text\">Elastic IP</code>即可</li>\n<li>在VPC -> Route tables里找到分配给Private Subnet的Route table, 点击Edit Routes编辑路由表。点击<code class=\"language-text\">Add route</code>，第一列填入<code class=\"language-text\">0.0.0.0/0</code>代表匹配所有其他ip。第二列选择<code class=\"language-text\">NAT Gateway</code>并选中刚才我们创建好的。</li>\n</ul>\n<p>部署完毕<code class=\"language-text\">NAT Gateway</code>后我们的EC2主机就可以访问外网了。我们可以通过跳板机登录上机器后执行<code class=\"language-text\">curl ip.sb</code>，返回的IP地址即我们访问公网使用的IP。这个IP应该与我们分配给<code class=\"language-text\">NAT Gateway</code>的<code class=\"language-text\">Elastic IP</code>保持一致。你可以尝试多部署几台EC2主机在Private Subnet中如下图所示</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 402px; '>\n      <a class='gatsby-resp-image-link' href='/static/ebe5cde52525acfe7416542ddfc737d4/0ec92/nat-gateway-explained.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 70.28571428571428%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB1klEQVQ4y51T+0/aYBTt//8vbOh+mMC2xMceyXTZ5FGdBpCBIKWl8GFh1IJY6INKW85uv6SNm6DbbnJyv/aee3Jy+lXAhlqtVry7rgtZUWCMxwjD8LfZuhI2icVLN4aBtixD0zSYpvlo/teCUUWOGs0mGGNQu13UGw0EQfCky2cdjkYjdFQVOnVD1//dYUyMu+d5cB0H4WUd9okIsojVE6LPOrRJLBL1JAkzUYxySAT/y+G9t+A9WN7DnN4m2W7KUVjnLCbqfQm18zyYVEWjLHIY1/JabiL4cPAnadip4evHt6idfUPu8y7yhL5UeST4EMKmCxpS+Iv5FNZUx1WtjHrljJ4n8Oy75OqszTAaLv0l/MCH7/uYW3MOhz6G4y7gU16WbWM8mfCzTX+OQ7Asi/Pi3ahH2QqlyzLypSJOqt+xf3iAHGWWKxXQGzBUWz/4+6PiFxwWjiBWT1FpXoAN+7RT4Ih2xItT5MtFaPoAwjEJpN9nkcpu42V6C6/30sh+eocrtYUCkV6kU3yWymwj8+ENjs9zaDMZOwcZbGVf0U4KO3sZvqNqXQgDfQiZKZB7MrpaDwrr0FnBdHaH4c1PtFQJ6rXK0SbOgFyYc5NzIiQ7pDGjCH4B0lIjkpmV4DsAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='nat-gateway-explained' title='nat-gateway-explained' src='/static/ebe5cde52525acfe7416542ddfc737d4/0ec92/nat-gateway-explained.png' srcset='/static/ebe5cde52525acfe7416542ddfc737d4/4edbd/nat-gateway-explained.png 175w,\n/static/ebe5cde52525acfe7416542ddfc737d4/13ae7/nat-gateway-explained.png 350w,\n/static/ebe5cde52525acfe7416542ddfc737d4/0ec92/nat-gateway-explained.png 402w' sizes='(max-width: 402px) 100vw, 402px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>\n  </a>\n    </span></p>\n<p>你会发现所有主机的公网IP都与<code class=\"language-text\">NAT Gateway</code>一致，也就是说<code class=\"language-text\">NAT Gateway</code>将Private Subnet中的私网IP多对一地映射成了自己的<code class=\"language-text\">Elastic IP</code>，节省了IP资源。这里<code class=\"language-text\">NAT Gateway</code>会对outbound流量的网络回包进行处理，送达至对应的私网ip，保证从EC2发出的网络请求响应能顺利送回。但如果直接从公网访问<code class=\"language-text\">NAT Gateway</code>的IP地址，并不能触达私网中的EC2主机。也就是说<code class=\"language-text\">NAT Gateway</code>是一个从内网到公网的“单行道”。</p>\n<h1>4. Elastic Load Balancer</h1>\n<p>那如何才能安全地对外暴露EC2提供的服务呢？那就需要使用<a href=\"https://aws.amazon.com/elasticloadbalancing/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Elastic Load Balancer</a>。顾名思义这是AWS提供的负载均衡器，总共分为三种：<code class=\"language-text\">Application Load Balancer</code>(ALB), <code class=\"language-text\">Network Load Balancer</code>(NLB), 和<code class=\"language-text\">Classic Load Balancer</code>(CLB)。其中ALB是针对7层(HTTP, HTTPS等等)的，NLB是针对4层(TCP, TLS, UDP等等)的，而CLB可以同时提供4层和7层服务，但已经是不被AWS推荐的过期产品，对比较新的功能的支持是有限的。ELB和<code class=\"language-text\">Nginx</code>, <code class=\"language-text\">HAProxy</code>等负载均衡器所提供的功能非常接近，但它是完全由AWS部署运维的，你只需要新建一个ELB并且配置规则即可，不需要考虑它是如何被部署的。\n首先，我们去EC2 -> Load Balancers -> Create Load Balancer创建ELB</p>\n<ul>\n<li>首先我们选择ALB</li>\n<li>\n<p>Configure Load Balancer:</p>\n<ul>\n<li>Listeners: 选择默认的HTTP和80端口</li>\n<li>Availability Zones: 选择我们的VPC以及Public Subnet。如果所选的Subnet没有与<code class=\"language-text\">Internet Gateway</code>相连，这里会给出警告。在当前的版本AWS为了可用性会强制要求ALB部署在两个或者以上的可用区中，可以自行在一个新的可用区新建一个Public Subnet。</li>\n</ul>\n</li>\n<li>Configure Security Settings: 由于我们选择的是HTTP而不是HTTPS，所以这一步可以略过。如果要暴露HTTPS服务，可以在这一步选择HTTP证书，ALB可以帮你做HTTPS证书卸载，并且支持SNI。</li>\n<li>Configure Security Groups: 选择Create a new security group。默认会为你准备好允许80端口TCP的规则。</li>\n<li>Configure Routing: 使用默认配置即可，新建一个target group。</li>\n<li>Register Targets: 手动选择在Private Subnet中创建的EC2主机</li>\n</ul>\n<p>此时我们有了一个指向EC2主机的ALB，对EC2主机，编辑Security Group允许从ALB的Security Group来的所有流量，并且登录到主机上开启一个监听<code class=\"language-text\">0.0.0.0:80</code>的HTTP服务，等待ALB的Health Check健康后就能通过访问ALB提供的DNS域名访问到EC2上部署的HTTP服务了。通过在<code class=\"language-text\">Target Group</code>中部署多台EC2，也可以达到负载均衡的目的，配合<a href=\"https://docs.aws.amazon.com/autoscaling/ec2/userguide/AutoScalingGroup.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Auto Scaling groups</a>更是可以做到弹性伸缩。部署好ELB后的网络结构如图:</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 381px; '>\n      <a class='gatsby-resp-image-link' href='/static/83310eaf939ae44c6c15589bb7c044e7/2add2/elb.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 94.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAADjUlEQVQ4y4WUi1NTRxTG87d3HAeBkoKgVccWlPCIYAG1toIRCwiBvF8mJJFACDfv5O59v/L17JLYtHXGnflm9+759rfn7ss3GAzwvdLudNGX2Xd9nOXjDcd1YdoWyR7WJMuC7TpoEezTaQy5QhFSownHc0Xsq284hnt58QkYGTjdG3gkqj1PiBdeN9sdlL5UYNPgUR/3j8uimO048JlD07eKRRNVr29QJthx+AzXNQm9Xu/r70Es10gQmfoMy4SqabBMC4ZhwDRNyLIsYKqmQ6o30Wi0cFWtodXuUkwRHoyW/h/eCGghm04in4kilQgjGT9BLHKEwucEtJ4E2AyWTqDuDeAqcM0+1K6Efrsm+m2jB1Ntw7M0sZ4+i9bQNRmMyyyMfAxWMQk5c4rq8XsY9TK0iwzkbASt+BH0YgIqxXm/UoijcrgrvHopSfM2YfI15EBTbkNZ/hXaiyC0tRWw1QD6C/eh7b4Gm5uBMjcLfXsL6pNHkO/8AHXvDRT/NDqTE5Cnp8BmpmA3qzBpswjowWJtsIVZqA8fQnv+DNrSIpR7E1C2glCfPoG6MA+D+tUHC1B+nIa6swE2dQ86+fSVAOSJu7BuKrAG3m2GltoDW3xM0Dko6wEoq8s06ySU0O80eBPaZhC9NeqnWtvagPLxT7D7fvQpM9lPmvfDalXBWT5+flzHgktQR27B6kiQa3TmqO0ZDHa/iQG1r3JJaPUqPPobz6BTQH1K8xoO69DYLgaOOdwUhx9IG5quQDMU6KYGVWdotOro9TvUVsA0hnqTzqDcFd99qvm3rPTBVBkyo2SIwVk+1xug0axhb2+H9Aq777bx9u1LJBOfkEmfIB47xEU5jUTsCOcFuoK0q9HIXyhQ+1Zx5HJnqNcv6frRLzv8ahEwlTohhZFIHBPsGOnsGZ6+eoGJZ4/xaCeI+c0Aft5Zh399EQfhfVQusjg/T6BYTCFPx02SLm+vHge2WjcUjKNMmZRKKWGO0AQ/ba5gOfQHFt+9xtLuG2wcvMfMy1WEwh9Q+ZJBQQCTAigyHAF5hvl8VAS5qUzQeDqMyfUlTAWfY4aym/1tDfPbQdwJ/IL90/3/AKOUYWUsw7Yk1oMHi8KUEObDyIHI5sNQoZMQPhIs9zmKEnnPh0A+Vqpf0aYQkL8aummIHRsXI2ka7br+fzFF/refkdfQxdPnGz0Y3vBdG6+53LH2uAbfqHn5G8S7bQ74g3wlAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='elb' title='elb' src='/static/83310eaf939ae44c6c15589bb7c044e7/2add2/elb.png' srcset='/static/83310eaf939ae44c6c15589bb7c044e7/4edbd/elb.png 175w,\n/static/83310eaf939ae44c6c15589bb7c044e7/13ae7/elb.png 350w,\n/static/83310eaf939ae44c6c15589bb7c044e7/2add2/elb.png 381w' sizes='(max-width: 381px) 100vw, 381px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy'>\n  </a>\n    </span></p>\n<h1>5. 总结</h1>\n<p>至此，我们已经搭建了一个出具规模的二层网络，将内部可信流量与外部不可信流量区分开，并且通过<code class=\"language-text\">NAT Gateway</code>与<code class=\"language-text\">ELB</code>为计算资源的弹性伸缩做好了铺垫。从图中我们可以看到，不管是<code class=\"language-text\">跳板机</code>，<code class=\"language-text\">ELB</code>还是<code class=\"language-text\">NAT Gateway</code>，所有的流量都是单向的，并且有自己的目的。我们可以通过配置不通的安全策略来控制每一条路径的安全性，使得整个网络结构安全可控。</p>\n<p>在接下来的文章中我们会介绍：</p>\n<ul>\n<li>如何安全快速地在VPC中访问AWS提供的诸如S3之类的服务？</li>\n<li>如何在AWS中访问数据库？</li>\n</ul>","excerpt":"在上一篇文章中从零搭建AWS网络(一): VPC与Internet Gateway中，我们学习了如何从零开始搭建一套最简单的AWS网络并通过Internet Gateway来向公网提供服务。在文章的最后我留下了两个问题： 没有详细配置Security Group等安全措施，安全性无法得到保障 实例直接配置了公网ip地址，缺少安全性和可扩展性，占用宝贵的ip资源 在今天的文章里，我们就来通过添加ELB，NAT Gateway等设施来解决这些问题。…","frontmatter":{"date":"April 19, 2021","path":"/aws-vpc-elb-and-nat-gateway","title":"从零搭建AWS网络(二): ELB与NAT Gateway"}}},"pageContext":{}},"staticQueryHashes":["1176552510","3649515864","63159454","846684790"]}